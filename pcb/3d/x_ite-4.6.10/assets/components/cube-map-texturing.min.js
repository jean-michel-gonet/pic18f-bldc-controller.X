!function(){var t=X3D.define;X3D.require;t("x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode",["x_ite/Components/Texturing/X3DTextureNode","x_ite/Bits/X3DConstants"],function(t,e){"use strict";function i(i){t.call(this,i),this.addType(e.X3DEnvironmentTextureNode)}return i.prototype=Object.assign(Object.create(t.prototype),{constructor:i,initialize:function(){t.prototype.initialize.call(this);var e=this.getBrowser().getContext();this.target=e.TEXTURE_CUBE_MAP,this.targets=[e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y]},set_live__:function(){this.isLive().getValue()?(this.getBrowser().getBrowserOptions().TextureQuality_.addInterest("set_textureQuality__",this),this.set_textureQuality__()):this.getBrowser().getBrowserOptions().TextureQuality_.removeInterest("set_textureQuality__",this)},set_textureQuality__:function(){var t=this.getBrowser().getDefaultTextureProperties();this.updateTextureProperties(this.target,!1,t,128,128,!1,!1,!1)},getTarget:function(){return this.target},getTargets:function(){return this.targets},clearTexture:function(){var t=new Uint8Array([255,255,255,255]);return function(){var e=this.getBrowser().getContext(),i=this.getTargets();e.bindTexture(this.getTarget(),this.getTexture());for(var r=0,n=i.length;r<n;++r)e.texImage2D(i[r],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,t)}}(),setShaderUniformsToChannel:function(t,e,i){t.activeTexture(t.TEXTURE0+e.getBrowser().getCubeMapTextureUnits()[i]),t.bindTexture(t.TEXTURE_CUBE_MAP,this.getTexture()),t.uniform1i(e.x3d_TextureType[i],4)}}),i}),t("x_ite/Components/CubeMapTexturing/ComposedCubeMapTexture",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode","x_ite/Bits/X3DCast","x_ite/Bits/X3DConstants"],function(t,e,i,r,n,s){"use strict";function a(t){r.call(this,t),this.addType(s.ComposedCubeMapTexture),this.textures=[null,null,null,null,null,null],this.loadStates=0}return a.prototype=Object.assign(Object.create(r.prototype),{constructor:a,fieldDefinitions:new i([new e(s.inputOutput,"metadata",new t.SFNode),new e(s.inputOutput,"front",new t.SFNode),new e(s.inputOutput,"back",new t.SFNode),new e(s.inputOutput,"left",new t.SFNode),new e(s.inputOutput,"right",new t.SFNode),new e(s.inputOutput,"bottom",new t.SFNode),new e(s.inputOutput,"top",new t.SFNode)]),getTypeName:function(){return"ComposedCubeMapTexture"},getComponentName:function(){return"CubeMapTexturing"},getContainerField:function(){return"texture"},initialize:function(){r.prototype.initialize.call(this),this.clearTexture(),this.isLive().addInterest("set_live__",this),this.front_.addInterest("set_texture__",this,0),this.back_.addInterest("set_texture__",this,1),this.left_.addInterest("set_texture__",this,2),this.right_.addInterest("set_texture__",this,3),this.top_.addInterest("set_texture__",this,5),this.bottom_.addInterest("set_texture__",this,4),this.set_texture__(this.front_,0),this.set_texture__(this.back_,1),this.set_texture__(this.left_,2),this.set_texture__(this.right_,3),this.set_texture__(this.top_,4),this.set_texture__(this.bottom_,5),this.set_live__()},set_texture__:function(t,e){var i=this.textures[e];if(i){var r="set_loadState__"+i.getId()+"_"+e;i.removeInterest("set_loadState__",this),i.loadState_.removeFieldCallback(r)}var i=this.textures[e]=n(s.X3DTexture2DNode,t);if(i){var r="set_loadState__"+i.getId()+"_"+e;i.addInterest("set_loadState__",this,i,e),i.loadState_.addFieldCallback(r,this.set_loadState__.bind(this,null,i,e))}this.set_loadState__(null,i,e)},set_loadState__:function(t,e,i){e?this.setLoadStateBit(e.checkLoadState(),i):this.setLoadStateBit(s.NOT_STARTED,i),this.setTextures()},setLoadStateBit:function(t,e){t===s.COMPLETE_STATE?this.loadStates|=1<<e:this.loadStates&=~(1<<e)},isComplete:function(){if(63!==this.loadStates)return!1;for(var t=this.textures,e=t[0].getWidth(),i=0;i<6;++i){var r=t[i];if(r.getWidth()!==e)return!1;if(r.getHeight()!==e)return!1}return!0},setTextures:function(){var t=this.getBrowser().getContext();if(t.bindTexture(this.getTarget(),this.getTexture()),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.isComplete()){for(var e=this.textures,i=0;i<6;++i){var t=this.getBrowser().getContext(),r=e[i],n=r.getWidth(),s=r.getHeight(),a=r.getData();t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!r.getFlipY()),t.pixelStorei(t.UNPACK_ALIGNMENT,1),a instanceof Uint8Array?t.texImage2D(this.getTargets()[i],0,t.RGBA,n,s,!1,t.RGBA,t.UNSIGNED_BYTE,a):t.texImage2D(this.getTargets()[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a)}this.set_textureQuality__()}else this.clearTexture();this.set_transparent__()},set_transparent__:function(){var t=this.textures,e=!1;if(this.isComplete())for(var i=0;i<6;++i)if(t[i].transparent_.getValue()){e=!0;break}this.setTransparent(e)}}),a}),t("x_ite/Rendering/DependentRenderer",["x_ite/Basic/X3DBaseNode","x_ite/Rendering/X3DRenderObject","x_ite/Bits/TraverseType"],function(t,e,i){"use strict";function r(i){t.call(this,i),e.call(this,i),this.renderObject=null}return r.prototype=Object.assign(Object.create(t.prototype),e.prototype,{constructor:r,initialize:function(){t.prototype.initialize.call(this),e.prototype.initialize.call(this)},isIndependent:function(){return!1},setRenderer:function(t){this.renderObject=t},getBrowser:function(){return this.renderObject.getBrowser()},getLayer:function(){return this.renderObject.getLayer()},getBackground:function(){return this.renderObject.getBackground()},getFog:function(){return this.renderObject.getFog()},getNavigationInfo:function(){return this.renderObject.getNavigationInfo()},getViewpoint:function(){return this.renderObject.getViewpoint()},getLightContainer:function(){return this.renderObject.getLights()[this.lightIndex++]},render:function(t,r,n){switch(t){case i.COLLISION:e.prototype.render.call(this,t,r,n);break;case i.DEPTH:e.prototype.render.call(this,t,r,n);break;case i.DISPLAY:this.lightIndex=0,e.prototype.render.call(this,t,r,n);for(var s=this.renderObject.getLights(),a=0,o=s.length;a<o;++a)s[a].getModelViewMatrix().pop()}}}),r}),t("x_ite/Components/CubeMapTexturing/GeneratedCubeMapTexture",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode","x_ite/Rendering/DependentRenderer","x_ite/Rendering/TextureBuffer","x_ite/Bits/X3DConstants","x_ite/Bits/TraverseType","standard/Math/Geometry/Camera","standard/Math/Geometry/ViewVolume","standard/Math/Numbers/Rotation4","standard/Math/Numbers/Vector3","standard/Math/Numbers/Vector4","standard/Math/Numbers/Matrix4","standard/Math/Algorithm"],function(t,e,i,r,n,s,a,o,u,h,g,_,d,p,x){"use strict";function l(t){r.call(this,t),this.addType(a.GeneratedCubeMapTexture),this.renderer=new n(t),this.projectionMatrix=new p,this.modelMatrix=new p,this.viewVolume=new h}var c=[new g(_.zAxis,new _(0,0,-1)),new g(_.zAxis,new _(0,0,1)),new g(_.zAxis,new _(1,0,0)),new g(_.zAxis,new _(-1,0,0)),new g(_.zAxis,new _(0,-1,0)),new g(_.zAxis,new _(0,1,0))],T=[new _(-1,-1,1),new _(-1,-1,1),new _(-1,-1,1),new _(-1,-1,1),new _(1,1,1),new _(1,1,1)],f=new p;return l.prototype=Object.assign(Object.create(r.prototype),{constructor:l,fieldDefinitions:new i([new e(a.inputOutput,"metadata",new t.SFNode),new e(a.inputOutput,"update",new t.SFString("NONE")),new e(a.initializeOnly,"size",new t.SFInt32(128)),new e(a.initializeOnly,"textureProperties",new t.SFNode)]),getTypeName:function(){return"GeneratedCubeMapTexture"},getComponentName:function(){return"CubeMapTexturing"},getContainerField:function(){return"texture"},initialize:function(){r.prototype.initialize.call(this),this.renderer.setup();var t=x.nextPowerOfTwo(this.size_.getValue());if(t>0){t=x.nextPowerOfTwo(t);var e=this.getBrowser().getContext(),i=new Uint8Array(t*t*4);e.bindTexture(this.getTarget(),this.getTexture());for(var n=0;n<6;++n)e.texImage2D(this.getTargets()[n],0,e.RGBA,t,t,0,e.RGBA,e.UNSIGNED_BYTE,i);this.viewport=new d(0,0,t,t),this.frameBuffer=new s(this.getBrowser(),t,t),this.isLive().addInterest("set_live__",this),this.set_live__()}},traverse:function(t,e){t===o.DISPLAY&&"NONE"!==this.update_.getValue()&&this.frameBuffer&&e.isIndependent()&&(e.getGeneratedCubeMapTextures().push(this),this.modelMatrix.assign(e.getModelViewMatrix().get()).multRight(e.getCameraSpaceMatrix().get()))},renderTexture:function(t,e){this.renderer.setRenderer(t);var i=this.renderer,r=t.getBrowser(),n=t.getLayer(),s=r.getContext(),a=i.getBackground(),h=i.getNavigationInfo(),g=i.getViewpoint(),_=r.getHeadlight(),d=h.headlight_.getValue(),l=h.getNearValue(),w=h.getFarValue(g),m=u.perspective(x.radians(90),l,w,1,1,this.projectionMatrix);this.setTransparent(a.getTransparent()),this.frameBuffer.bind(),i.getViewVolumes().push(this.viewVolume.set(m,this.viewport,this.viewport)),i.getProjectionMatrix().pushMatrix(m),s.bindTexture(this.getTarget(),this.getTexture()),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1);for(var C=0;C<6;++C){s.clear(s.COLOR_BUFFER_BIT),i.getCameraSpaceMatrix().pushMatrix(this.modelMatrix),i.getCameraSpaceMatrix().rotate(c[C]),i.getCameraSpaceMatrix().scale(T[C]);try{i.getInverseCameraSpaceMatrix().pushMatrix(f.assign(i.getCameraSpaceMatrix().get()).inverse())}catch(t){console.log(t),i.getInverseCameraSpaceMatrix().pushMatrix(p.Identity)}i.getModelViewMatrix().pushMatrix(f),d&&(_.getModelViewMatrix().pushMatrix(f),_.getModelViewMatrix().multLeft(g.getCameraSpaceMatrix())),n.traverse(o.DISPLAY,i),d&&_.getModelViewMatrix().pop(),i.getModelViewMatrix().pop(),i.getCameraSpaceMatrix().pop(),i.getInverseCameraSpaceMatrix().pop();var M=this.frameBuffer.readPixels(),E=this.frameBuffer.getWidth(),b=this.frameBuffer.getHeight();s.texImage2D(this.getTargets()[C],0,s.RGBA,E,b,!1,s.RGBA,s.UNSIGNED_BYTE,M)}this.set_textureQuality__(),i.getProjectionMatrix().pop(),i.getViewVolumes().pop(),this.frameBuffer.unbind(),"NEXT_FRAME_ONLY"===this.update_.getValue()&&(this.update_="NONE")}}),l}),t("x_ite/Components/CubeMapTexturing/ImageCubeMapTexture",["jquery","x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode","x_ite/Components/Networking/X3DUrlObject","x_ite/Bits/X3DConstants","x_ite/Browser/Networking/urls","standard/Networking/URI","standard/Math/Numbers/Vector2","standard/Math/Algorithm","x_ite/DEBUG"],function(t,e,i,r,n,s,a,o,u,h,g,_){"use strict";function d(t){n.call(this,t),s.call(this,t),this.addType(a.ImageCubeMapTexture),this.urlStack=new e.MFString}var p=new Uint8Array([255,255,255,255]),x=[new h(1,1),new h(3,1),new h(0,1),new h(2,1),new h(1,0),new h(1,2)];return d.prototype=Object.assign(Object.create(n.prototype),s.prototype,{constructor:d,fieldDefinitions:new r([new i(a.inputOutput,"metadata",new e.SFNode),new i(a.inputOutput,"url",new e.MFString),new i(a.initializeOnly,"textureProperties",new e.SFNode)]),getTypeName:function(){return"ImageCubeMapTexture"},getComponentName:function(){return"CubeMapTexturing"},getContainerField:function(){return"texture"},initialize:function(){n.prototype.initialize.call(this),s.prototype.initialize.call(this);var e=this.getBrowser().getContext();e.bindTexture(this.getTarget(),this.getTexture());for(var i=0;i<6;++i)e.texImage2D(this.getTargets()[i],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,p);this.url_.addInterest("set_url__",this),this.canvas=t("<canvas></canvas>"),this.image=t("<img></img>"),this.image.on("load",this.setImage.bind(this)),this.image.on("error",this.setError.bind(this)),this.image.bind("abort",this.setError.bind(this)),this.image[0].crossOrigin="Anonymous",this.requestAsyncLoad()},set_url__:function(){this.setLoadState(a.NOT_STARTED_STATE),this.requestAsyncLoad()},requestAsyncLoad:function(){this.checkLoadState()!==a.COMPLETE_STATE&&this.checkLoadState()!==a.IN_PROGRESS_STATE&&(this.setLoadState(a.IN_PROGRESS_STATE),this.urlStack.setValue(this.url_),this.loadNext())},loadNext:function(){if(0===this.urlStack.length)return this.clearTexture(),void this.setLoadState(a.FAILED_STATE);this.URL=new u(this.urlStack.shift()),this.URL=this.getExecutionContext().getURL().transform(this.URL),this.image.attr("src",this.URL)},setError:function(){var t=this.URL.toString();_&&(this.URL.isLocal()||"localhost"===this.URL.host||t.match(o.getFallbackExpression())||this.urlStack.unshift(o.getFallbackUrl(t))),"data"!==this.URL.scheme&&console.warn("Error loading image:",this.URL.toString()),this.loadNext()},setImage:function(){_&&"data"!==this.URL.scheme&&console.info("Done loading image cube map texture:",this.URL.toString());try{var t=this.image[0],e=t.width,i=t.height,r=Math.floor(e/4),n=Math.floor(i/3),s=this.canvas[0],o=s.getContext("2d");g.isPowerOfTwo(r)&&g.isPowerOfTwo(n)&&4*r===e&&3*n===i?(s.width=e,s.height=i,o.drawImage(t,0,0)):(r=g.nextPowerOfTwo(r),n=g.nextPowerOfTwo(n),e=4*r,i=3*n,s.width=e,s.height=i,o.drawImage(t,0,0,t.width,t.height,0,0,e,i));var u=this.getBrowser().getContext(),h=!0;u.bindTexture(this.getTarget(),this.getTexture()),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1);for(var d=0;d<6;++d){var p=o.getImageData(x[d].x*r,x[d].y*n,r,n).data;if(h)for(var l=3;l<p.length;l+=4)if(255!==p[l]){h=!1;break}u.texImage2D(this.getTargets()[d],0,u.RGBA,r,n,!1,u.RGBA,u.UNSIGNED_BYTE,new Uint8Array(p))}this.set_textureQuality__(),this.setTransparent(!h),this.setLoadState(a.COMPLETE_STATE)}catch(t){console.log(t.message),this.setError()}}}),d}),t(["x_ite/Components","x_ite/Components/CubeMapTexturing/ComposedCubeMapTexture","x_ite/Components/CubeMapTexturing/GeneratedCubeMapTexture","x_ite/Components/CubeMapTexturing/ImageCubeMapTexture","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode"],function(t,e,i,r,n){"use strict";t.addComponent({name:"CubeMapTexturing",types:{ComposedCubeMapTexture:e,GeneratedCubeMapTexture:i,ImageCubeMapTexture:r},abstractTypes:{X3DEnvironmentTextureNode:n}})})}();
