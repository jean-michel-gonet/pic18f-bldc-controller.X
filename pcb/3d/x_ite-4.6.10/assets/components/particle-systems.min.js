!function(){var t=X3D.define;X3D.require;t("x_ite/Components/ParticleSystems/X3DParticleEmitterNode",["x_ite/Components/Core/X3DNode","x_ite/Bits/X3DConstants","standard/Math/Numbers/Vector3","standard/Math/Numbers/Rotation4","standard/Math/Geometry/Line3","standard/Math/Geometry/Plane3","standard/Math/Algorithm","standard/Math/Algorithms/QuickSort"],function(t,e,i,s,r,n,o,a){"use strict";function l(t,e){return f.getDistanceToPoint(t)<f.getDistanceToPoint(e)}function h(t,e){return t<f.getDistanceToPoint(e)}function c(i){t.call(this,i),this.addType(e.X3DParticleEmitterNode),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.rotations=[],this.intersections=[],this.intersectionNormals=[],this.sorter=new a(this.intersections,l)}var d=new i(0,0,0),u=new i(0,0,0),m=new r(i.Zero,i.zAxis),f=new n(i.Zero,i.zAxis);return c.prototype=Object.assign(Object.create(t.prototype),{constructor:c,initialize:function(){t.prototype.initialize.call(this),this.speed_.addInterest("set_speed__",this),this.variation_.addInterest("set_variation__",this),this.mass_.addInterest("set_mass__",this),this.set_speed__(),this.set_variation__(),this.set_mass__()},set_speed__:function(){this.speed=this.speed_.getValue()},set_variation__:function(){this.variation=this.variation_.getValue()},set_mass__:function(){this.mass=this.mass_.getValue()},isExplosive:function(){return!1},getMass:function(){return this.mass},getRandomLifetime:function(t,e){var i=t*e,s=Math.max(0,t-i),r=t+i;return Math.random()*(r-s)+s},getRandomSpeed:function(){var t=this.speed,e=t*this.variation,i=Math.max(0,t-e),s=t+e;return Math.random()*(s-i)+i},getSphericalRandomVelocity:function(t){return this.getRandomNormal(t).multiply(this.getRandomSpeed())},getRandomValue:function(t,e){return Math.random()*(e-t)+t},getRandomNormal:function(t){var e=this.getRandomValue(-1,1)*Math.PI,i=this.getRandomValue(-1,1),s=Math.acos(i),r=Math.sin(s);return t.set(Math.sin(e)*r,Math.cos(e)*r,i)},getRandomNormalWithAngle:function(t,e){var i=(2*Math.random()-1)*Math.PI,s=this.getRandomValue(Math.cos(t),1),r=Math.acos(s),n=Math.sin(r);return e.set(Math.sin(i)*n,Math.cos(i)*n,s)},getRandomNormalWithDirectionAndAngle:function(t,e,s){return rotation.setFromToVec(i.zAxis,t),rotation.multVecRot(this.getRandomNormalWithAngle(e,s))},getRandomSurfaceNormal:function(t){var e=this.getRandomValue(-1,1)*Math.PI,i=Math.pow(Math.random(),1/3),s=Math.acos(i),r=Math.sin(s);return t.set(Math.sin(e)*r,Math.cos(e)*r,i)},animate:function(t,e){for(var r=t.particles,n=t.numParticles,o=t.createParticles,a=t.particleLifetime,l=t.lifetimeVariation,h=t.speeds,c=t.velocities,m=t.turbulences,f=this.rotations,p=t.numForces,_=t.boundedVertices.length,y=t.boundedVolume,g=f.length;g<p;++g)f[g]=new s(0,0,1,0);for(var g=0;g<p;++g)f[g].setFromToVec(i.zAxis,c[g]);for(var g=0;g<n;++g){var A=r[g],x=A.elapsedTime+e;if(x>A.lifetime)A.lifetime=this.getRandomLifetime(a,l),A.elapsedTime=0,o?(++A.life,this.getRandomPosition(A.position),this.getRandomVelocity(A.velocity)):A.position.set(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);else{for(var F=A.position,w=A.velocity,R=0;R<p;++R)w.add(f[R].multVecRot(this.getRandomNormalWithAngle(m[R],d)).multiply(h[R]));_?(u.x=F.x,u.y=F.y,u.z=F.z,F.x+=w.x*e,F.y+=w.y*e,F.z+=w.z*e,this.bounce(y,u,F,w)):(F.x+=w.x*e,F.y+=w.y*e,F.z+=w.z*e),A.elapsedTime=x}}t.colorMaterial&&this.getColors(r,t.colorKeys,t.colorRamp,n)},bounce:function(t,e,i,s){d.assign(s).normalize(),m.set(e,d);var r=this.intersections,n=this.intersectionNormals,a=t.intersectsLine(m,r,n);if(a){for(var l=0;l<a;++l)r[l].index=l;f.set(e,d),this.sorter.sort(0,a);var c=o.upperBound(r,0,a,0,h);if(c<a){var u=r[c],p=n[u.index];if(f.set(u,p),f.getDistanceToPoint(e)*f.getDistanceToPoint(i)<0){var _=2*p.dot(s);s.x-=p.x*_,s.y-=p.y*_,s.z-=p.z*_,d.assign(s).normalize();var y=u.distance(e);i.x=u.x+d.x*y,i.y=u.y+d.y*y,i.z=u.z+d.z*y}}}},getColors:function(t,e,i,s){for(var r=e.length,n=0,a=0,l=0,h=0;h<s;++h){var c=t[h],d=c.elapsedTime/c.lifetime,u=c.color;if(1==r||d<=e[0])n=0,a=0,l=0;else if(d>=e[r-1])n=r-2,a=r-1,l=1;else{var m=o.upperBound(e,0,r,d,o.less);if(m<r){a=m,n=m-1;var f=e[n],p=e[a];l=o.clamp((d-f)/(p-f),0,1)}else n=0,a=0,l=0}var _=i[n],y=i[a];u.x=_.x+l*(y.x-_.x),u.y=_.y+l*(y.y-_.y),u.z=_.z+l*(y.z-_.z),u.w=_.w+l*(y.w-_.w)}}}),c}),t("x_ite/Components/ParticleSystems/PointEmitter",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Bits/X3DConstants","standard/Math/Numbers/Vector3"],function(t,e,i,s,r,n){"use strict";function o(t){s.call(this,t),this.addType(r.PointEmitter),this.position_.setUnit("length"),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.direction=new n(0,0,0)}return o.prototype=Object.assign(Object.create(s.prototype),{constructor:o,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"position",new t.SFVec3f),new e(r.inputOutput,"direction",new t.SFVec3f(0,1,0)),new e(r.inputOutput,"speed",new t.SFFloat),new e(r.inputOutput,"variation",new t.SFFloat(.25)),new e(r.initializeOnly,"mass",new t.SFFloat),new e(r.initializeOnly,"surfaceArea",new t.SFFloat)]),getTypeName:function(){return"PointEmitter"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"emitter"},initialize:function(){s.prototype.initialize.call(this),this.position_.addInterest("set_position__",this),this.direction_.addInterest("set_direction__",this),this.set_position__(),this.set_direction__()},set_position__:function(){this.position=this.position_.getValue()},set_direction__:function(){this.direction.assign(this.direction_.getValue()).normalize(),this.direction.equals(n.Zero)?this.getRandomVelocity=this.getSphericalRandomVelocity:delete this.getRandomVelocity},getRandomPosition:function(t){return t.assign(this.position)},getRandomVelocity:function(t){var e=this.direction,i=this.getRandomSpeed();return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}}),o}),t("x_ite/Browser/ParticleSystems/X3DParticleSystemsContext",["x_ite/Components/ParticleSystems/PointEmitter"],function(t){"use strict";function e(){}return e.prototype={getDefaultEmitter:function(){return void 0!==this.defaultEmitter?this.defaultEmitter:(this.defaultEmitter=new t(this.getPrivateScene()),this.defaultEmitter.setup(),this.defaultEmitter)}},e}),t("x_ite/Components/ParticleSystems/X3DParticlePhysicsModelNode",["x_ite/Components/Core/X3DNode","x_ite/Bits/X3DConstants"],function(t,e){"use strict";function i(i){t.call(this,i),this.addType(e.X3DParticlePhysicsModelNode)}return i.prototype=Object.assign(Object.create(t.prototype),{constructor:i,addForce:function(){}}),i}),t("x_ite/Components/ParticleSystems/BoundedPhysicsModel",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticlePhysicsModelNode","x_ite/Bits/X3DConstants","x_ite/Bits/X3DCast"],function(t,e,i,s,r,n){"use strict";function o(t){s.call(this,t),this.addType(r.BoundedPhysicsModel)}return o.prototype=Object.assign(Object.create(s.prototype),{constructor:o,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"enabled",new t.SFBool(!0)),new e(r.inputOutput,"geometry",new t.SFNode)]),getTypeName:function(){return"BoundedPhysicsModel"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"physics"},initialize:function(){s.prototype.initialize.call(this),this.geometry_.addInterest("set_geometry__",this),this.set_geometry__()},set_geometry__:function(){this.geometryNode&&this.geometryNode.rebuild_.removeInterest("addNodeEvent",this),this.geometryNode=n(r.X3DGeometryNode,this.geometry_),this.geometryNode&&this.geometryNode.rebuild_.addInterest("addNodeEvent",this)},addGeometry:function(t,e){if(this.geometryNode){for(var i=this.geometryNode.getNormals().getValue(),s=this.geometryNode.getVertices().getValue(),r=0,n=i.length;r<n;++r)t.push(i[r]);for(var r=0,n=s.length;r<n;++r)e.push(s[r])}}}),o}),t("x_ite/Components/ParticleSystems/ConeEmitter",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Bits/X3DConstants","standard/Math/Numbers/Vector3","standard/Math/Numbers/Rotation4"],function(t,e,i,s,r,n,o){"use strict";function a(t){s.call(this,t),this.addType(r.ConeEmitter),this.position_.setUnit("length"),this.angle_.setUnit("angle"),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.rotation=new o(0,0,1,0)}return a.prototype=Object.assign(Object.create(s.prototype),{constructor:a,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"position",new t.SFVec3f),new e(r.inputOutput,"direction",new t.SFVec3f(0,1,0)),new e(r.inputOutput,"angle",new t.SFFloat(.7854)),new e(r.inputOutput,"speed",new t.SFFloat),new e(r.inputOutput,"variation",new t.SFFloat(.25)),new e(r.initializeOnly,"mass",new t.SFFloat),new e(r.initializeOnly,"surfaceArea",new t.SFFloat)]),getTypeName:function(){return"ConeEmitter"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"emitter"},initialize:function(){s.prototype.initialize.call(this),this.position_.addInterest("set_position__",this),this.direction_.addInterest("set_direction__",this),this.angle_.addInterest("set_angle__",this),this.set_position__(),this.set_direction__(),this.set_angle__()},set_position__:function(){this.position=this.position_.getValue()},set_direction__:function(){var t=this.direction_.getValue();this.rotation.setFromToVec(n.zAxis,t),t.equals(n.Zero)?this.getRandomVelocity=this.getSphericalRandomVelocity:delete this.getRandomVelocity},set_angle__:function(){this.angle=this.angle_.getValue()},getRandomPosition:function(t){return t.assign(this.position)},getRandomVelocity:function(t){return this.rotation.multVecRot(this.getRandomNormalWithAngle(this.angle,t).multiply(this.getRandomSpeed()))}}),a}),t("x_ite/Components/ParticleSystems/ExplosionEmitter",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Bits/X3DConstants"],function(t,e,i,s,r){"use strict";function n(t){s.call(this,t),this.addType(r.ExplosionEmitter),this.position_.setUnit("length"),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.getRandomVelocity=this.getSphericalRandomVelocity}return n.prototype=Object.assign(Object.create(s.prototype),{constructor:n,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"position",new t.SFVec3f),new e(r.inputOutput,"speed",new t.SFFloat),new e(r.inputOutput,"variation",new t.SFFloat(.25)),new e(r.initializeOnly,"mass",new t.SFFloat),new e(r.initializeOnly,"surfaceArea",new t.SFFloat)]),getTypeName:function(){return"ExplosionEmitter"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"emitter"},initialize:function(){s.prototype.initialize.call(this),this.position_.addInterest("set_position__",this),this.set_position__()},set_position__:function(){this.position=this.position_.getValue()},isExplosive:function(){return!0},getRandomPosition:function(t){return t.assign(this.position)}}),n}),t("x_ite/Components/ParticleSystems/ForcePhysicsModel",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticlePhysicsModelNode","x_ite/Bits/X3DConstants"],function(t,e,i,s,r){"use strict";function n(t){s.call(this,t),this.addType(r.ForcePhysicsModel),this.force_.setUnit("force")}return n.prototype=Object.assign(Object.create(s.prototype),{constructor:n,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"enabled",new t.SFBool(!0)),new e(r.inputOutput,"force",new t.SFVec3f(0,-9.8,0))]),getTypeName:function(){return"ForcePhysicsModel"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"physics"},addForce:function(t,e,i,s){this.enabled_.getValue()&&(i[t].assign(this.force_.getValue()),s[t]=0)}}),n}),t("standard/Math/Utility/BVH",["standard/Math/Numbers/Vector3","standard/Math/Geometry/Plane3","standard/Math/Algorithms/QuickSort"],function(t,e,i){"use strict";function s(t,e){function i(t,s){var r=i.vertices;return e=i.axis,Math.min(r[t+e],r[t+4+e],r[t+8+e])<Math.min(r[s+e],r[s+4+e],r[s+8+e])}return i.vertices=t,i.axis=e,i}function r(t,e){this.vertices=t.vertices,this.normals=t.normals,this.i4=12*e,this.i3=9*e}function n(i,s,o,c){this.min=new t(0,0,0),this.max=new t(0,0,0),this.planes=[],this.intersection=new t(0,0,0);var u=i.vertices,m=this.min,f=this.max,p=o+c,_=12*s[o];m.set(u[_],u[_+1],u[_+2]),f.assign(m);for(var y=o;y<p;++y)_=12*s[y],a.set(u[_],u[_+1],u[_+2]),l.set(u[_+4],u[_+5],u[_+6]),h.set(u[_+8],u[_+9],u[_+10]),m.min(a,l,h),f.max(a,l,h);for(var y=0;y<5;++y)this.planes[y]=new e(y%2?m:f,d[y]);if(c>2){i.sorter.compare.axis=this.getLongestAxis(m,f),i.sorter.sort(o,p);var g=c>>>1}else var g=1;var A=c-g;this.left=g>1?new n(i,s,o,g):new r(i,s[o]),this.right=A>1?new n(i,s,o+g,A):new r(i,s[o+g])}function o(t,e){this.vertices=t,this.normals=e;var o=t.length/12;switch(o){case 0:this.root=null;break;case 1:this.root=new r(this,0);break;default:for(var a=[],l=0;l<o;++l)a.push(l);this.sorter=new i(a,s(t,0)),this.root=new n(this,a,0,o)}}var a=new t(0,0,0),l=new t(0,0,0),h=new t(0,0,0),c={u:0,v:0,t:0},d=[new t(0,0,1),new t(0,0,-1),new t(0,1,0),new t(0,-1,0),new t(1,0,0)];return r.prototype={intersectsLine:function(e,i,s){var r=this.vertices,n=this.normals,o=this.i4,d=this.i3;if(a.x=r[o],a.y=r[o+1],a.z=r[o+2],l.x=r[o+4],l.y=r[o+5],l.z=r[o+6],h.x=r[o+8],h.y=r[o+9],h.z=r[o+10],e.intersectsTriangle(a,l,h,c)){var u=c.u,m=c.v,f=1-u-m,p=i.size++;p>=i.length&&i.push(new t(0,0,0)),i[p].set(f*r[o]+u*r[o+4]+m*r[o+8],f*r[o+1]+u*r[o+5]+m*r[o+9],f*r[o+2]+u*r[o+6]+m*r[o+10]),s&&(p>=s.length&&s.push(new t(0,0,0)),s[p].set(f*n[d]+u*n[d+3]+m*n[d+6],f*n[d+1]+u*n[d+4]+m*n[d+7],f*n[d+2]+u*n[d+5]+m*n[d+8]))}}},n.prototype={intersectsLine:function(t,e,i){this.intersectsBBox(t)&&(this.left.intersectsLine(t,e,i),this.right.intersectsLine(t,e,i))},intersectsBBox:function(t){var e=this.planes,i=this.min,s=this.max,r=i.x,n=s.x,o=i.y,a=s.y,l=i.z,h=s.z,c=this.intersection;return!!(e[0].intersectsLine(t,c)&&c.x>=r&&c.x<=n&&c.y>=o&&c.y<=a)||(!!(e[1].intersectsLine(t,c)&&c.x>=r&&c.x<=n&&c.y>=o&&c.y<=a)||(!!(e[2].intersectsLine(t,c)&&c.x>=r&&c.x<=n&&c.z>=l&&c.z<=h)||(!!(e[3].intersectsLine(t,c)&&c.x>=r&&c.x<=n&&c.z>=l&&c.z<=h)||!!(e[4].intersectsLine(t,c)&&c.y>=o&&c.y<=a&&c.z>=l&&c.z<=h))))},getLongestAxis:function(t,e){var i=e.x-t.x,s=e.y-t.y,r=e.z-t.z;return i<s?s<r?2:1:i<r?2:0}},o.prototype={constructor:o,intersectsLine:function(t,e,i){return e.size=0,this.root?(this.root.intersectsLine(t,e,i),e.size):0}},o}),t("x_ite/Components/ParticleSystems/ParticleSystem",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/Shape/X3DShapeNode","x_ite/Bits/TraverseType","x_ite/Bits/X3DConstants","x_ite/Bits/X3DCast","standard/Math/Numbers/Color4","standard/Math/Numbers/Vector3","standard/Math/Numbers/Vector4","standard/Math/Numbers/Matrix4","standard/Math/Numbers/Matrix3","standard/Math/Algorithms/QuickSort","standard/Math/Algorithm","standard/Math/Utility/BVH"],function(t,e,i,s,r,n,o,a,l,h,c,d,u,m,f){"use strict";function p(t,e){return t.distance<e.distance}function _(t){s.call(this,t),this.addType(n.ParticleSystem),this.particleSize_.setUnit("length"),this.createParticles=!0,this.particles=[],this.velocities=[],this.speeds=[],this.turbulences=[],this.geometryType=g,this.maxParticles=0,this.numParticles=0,this.particleLifetime=0,this.lifetimeVariation=0,this.emitterNode=null,this.forcePhysicsModelNodes=[],this.boundedPhysicsModelNodes=[],this.boundedNormals=[],this.boundedVertices=[],this.boundedVolume=null,this.creationTime=0,this.pauseTime=0,this.deltaTime=0,this.numForces=0,this.colorKeys=[],this.colorRamppNode=null,this.colorRamp=[],this.colorMaterial=!1,this.texCoordKeys=[],this.texCoordRampNode=null,this.texCoordRamp=[],this.texCoordAnim=!1,this.vertexCount=0,this.shaderNode=null,this.rotation=new d,this.particleSorter=new u(this.particles,p),this.sortParticles=!1}var y=0,g=y++,A=y++,x=y++,F=y++,w=y++,R=y++,v={POINT:g,LINE:A,TRIANGLE:x,QUAD:F,GEOMETRY:w,SPRITE:R},P=new c,b=new l(0,0,0),S=new l(0,0,0),B=new l(0,0,0),N=new l(0,0,0),C=new l(0,0,0),T=new l(0,0,0),V=new l(0,0,0),D=new l(0,0,0),M=new l(0,0,0),I=new l(0,0,0);return _.prototype=Object.assign(Object.create(s.prototype),{constructor:_,fieldDefinitions:new i([new e(n.inputOutput,"metadata",new t.SFNode),new e(n.inputOutput,"enabled",new t.SFBool(!0)),new e(n.inputOutput,"createParticles",new t.SFBool(!0)),new e(n.initializeOnly,"geometryType",new t.SFString("QUAD")),new e(n.inputOutput,"maxParticles",new t.SFInt32(200)),new e(n.inputOutput,"particleLifetime",new t.SFFloat(5)),new e(n.inputOutput,"lifetimeVariation",new t.SFFloat(.25)),new e(n.inputOutput,"particleSize",new t.SFVec2f(.02,.02)),new e(n.initializeOnly,"emitter",new t.SFNode),new e(n.initializeOnly,"physics",new t.MFNode),new e(n.initializeOnly,"colorKey",new t.MFFloat),new e(n.initializeOnly,"colorRamp",new t.SFNode),new e(n.initializeOnly,"texCoordKey",new t.MFFloat),new e(n.initializeOnly,"texCoordRamp",new t.SFNode),new e(n.outputOnly,"isActive",new t.SFBool),new e(n.initializeOnly,"bboxSize",new t.SFVec3f(-1,-1,-1)),new e(n.initializeOnly,"bboxCenter",new t.SFVec3f),new e(n.inputOutput,"appearance",new t.SFNode),new e(n.inputOutput,"geometry",new t.SFNode)]),getTypeName:function(){return"ParticleSystem"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"children"},initialize:function(){s.prototype.initialize.call(this);var t=this.getBrowser().getContext();this.isLive().addInterest("set_live__",this),this.getBrowser().getBrowserOptions().Shading_.addInterest("set_shader__",this),this.enabled_.addInterest("set_enabled__",this),this.createParticles_.addInterest("set_createParticles__",this),this.geometryType_.addInterest("set_geometryType__",this),this.maxParticles_.addInterest("set_enabled__",this),this.particleLifetime_.addInterest("set_particleLifetime__",this),this.lifetimeVariation_.addInterest("set_lifetimeVariation__",this),this.emitter_.addInterest("set_emitter__",this),this.physics_.addInterest("set_physics__",this),this.colorKey_.addInterest("set_color__",this),this.colorRamp_.addInterest("set_colorRamp__",this),this.texCoordKey_.addInterest("set_texCoord__",this),this.texCoordRamp_.addInterest("set_texCoordRamp__",this),this.idBuffer=t.createBuffer(),this.positionBuffer=t.createBuffer(),this.elapsedTimeBuffer=t.createBuffer(),this.lifeBuffer=t.createBuffer(),this.colorBuffer=t.createBuffer(),this.texCoordBuffers=[t.createBuffer()],this.normalBuffer=t.createBuffer(),this.vertexBuffer=t.createBuffer();for(var e=1,i=this.getBrowser().getMaxTextures();e<i;++e)this.texCoordBuffers.push(this.texCoordBuffers[0]);this.idArray=new Float32Array,this.positionArray=new Float32Array,this.elapsedTimeArray=new Float32Array,this.lifeArray=new Float32Array,this.colorArray=new Float32Array,this.texCoordArray=new Float32Array,this.normalArray=new Float32Array,this.vertexArray=new Float32Array,this.primitiveMode=t.TRIANGLES,this.set_emitter__(),this.set_enabled__(),this.set_createParticles__(),this.set_particleLifetime__(),this.set_lifetimeVariation__(),this.set_physics__(),this.set_colorRamp__(),this.set_texCoordRamp__()},set_bbox__:function(){this.bboxSize_.getValue().equals(this.getDefaultBBoxSize())?this.bbox.set():this.bbox.set(this.bboxSize_.getValue(),this.bboxCenter_.getValue()),this.bboxSize.assign(this.bbox.size),this.bboxCenter.assign(this.bbox.center)},set_transparent__:function(){switch(this.geometryType){case g:this.setTransparent(!0);break;default:this.setTransparent(this.getAppearance()&&this.getAppearance().getTransparent()||this.colorRampNode&&this.colorRampNode.getTransparent()||this.geometryType===w&&this.geometryNode&&this.geometryNode.getTransparent())}},set_live__:function(){this.isLive().getValue()?this.isActive_.getValue()&&this.maxParticles_.getValue()&&(this.getBrowser().sensorEvents().addInterest("animateParticles",this),this.pauseTime&&(this.creationTime+=performance.now()/1e3-this.pauseTime,this.pauseTime=0)):this.isActive_.getValue()&&this.maxParticles_.getValue()&&(this.getBrowser().sensorEvents().removeInterest("animateParticles",this),0===this.pauseTime&&(this.pauseTime=performance.now()/1e3))},set_enabled__:function(){this.enabled_.getValue()&&this.maxParticles_.getValue()?this.isActive_.getValue()||(this.isLive().getValue()?(this.getBrowser().sensorEvents().addInterest("animateParticles",this),this.pauseTime=0):this.pauseTime=performance.now()/1e3,this.isActive_=!0):this.isActive_.getValue()&&(this.isLive().getValue()&&this.getBrowser().sensorEvents().removeInterest("animateParticles",this),this.isActive_=!1,this.numParticles=0),this.set_maxParticles__()},set_createParticles__:function(){this.createParticles=this.createParticles_.getValue()},set_geometryType__:function(){var t=this.getBrowser().getContext(),e=this.maxParticles;switch(this.geometryType=v[this.geometryType_.getValue()],this.geometryType||(this.geometryType=g),this.geometryType){case g:this.idArray=new Float32Array(e),this.positionArray=new Float32Array(3*e),this.elapsedTimeArray=new Float32Array(e),this.lifeArray=new Float32Array(e),this.colorArray=new Float32Array(4*e),this.texCoordArray=new Float32Array,this.normalArray=new Float32Array,this.vertexArray=new Float32Array(4*e);for(var i=0,s=this.idArray,r=s.length;i<r;++i)s[i]=i;this.colorArray.fill(1),this.vertexArray.fill(1),this.primitiveMode=t.POINTS,this.texCoordCount=0,this.vertexCount=1;break;case A:this.idArray=new Float32Array(2*e),this.positionArray=new Float32Array(6*e),this.elapsedTimeArray=new Float32Array(2*e),this.lifeArray=new Float32Array(2*e),this.colorArray=new Float32Array(8*e),this.texCoordArray=new Float32Array,this.normalArray=new Float32Array,this.vertexArray=new Float32Array(8*e);for(var i=0,s=this.idArray,r=s.length;i<r;++i)s[i]=Math.floor(i/2);this.colorArray.fill(1),this.vertexArray.fill(1),this.primitiveMode=t.LINES,this.texCoordCount=2,this.vertexCount=2;break;case x:case F:case R:this.idArray=new Float32Array(6*e),this.positionArray=new Float32Array(18*e),this.elapsedTimeArray=new Float32Array(6*e),this.lifeArray=new Float32Array(6*e),this.colorArray=new Float32Array(24*e),this.texCoordArray=new Float32Array(24*e),this.normalArray=new Float32Array(18*e),this.vertexArray=new Float32Array(24*e);for(var i=0,s=this.idArray,r=s.length;i<r;++i)s[i]=Math.floor(i/6);this.colorArray.fill(1),this.vertexArray.fill(1);for(var n=this.texCoordArray,o=this.normalArray,i=0,a=18*e;i<a;i+=3)o[i]=0,o[i+1]=0,o[i+2]=1;t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.bufferData(t.ARRAY_BUFFER,this.normalArray,t.STATIC_DRAW);for(var i=0;i<e;++i){var l=24*i;n[l]=n[l+12]=0,n[l+1]=n[l+13]=0,n[l+2]=n[l+14]=0,n[l+3]=n[l+15]=1,n[l+4]=1,n[l+5]=0,n[l+6]=0,n[l+7]=1,n[l+8]=n[l+16]=1,n[l+9]=n[l+17]=1,n[l+10]=n[l+18]=0,n[l+11]=n[l+19]=1,n[l+20]=0,n[l+21]=1,n[l+22]=0,n[l+23]=1}t.bindBuffer(t.ARRAY_BUFFER,this.texCoordBuffers[0]),t.bufferData(t.ARRAY_BUFFER,this.texCoordArray,t.STATIC_DRAW),this.primitiveMode=t.TRIANGLES,this.texCoordCount=4,this.vertexCount=6;break;case w:this.texCoordCount=0,this.vertexCount=0}t.bindBuffer(t.ARRAY_BUFFER,this.idBuffer),t.bufferData(t.ARRAY_BUFFER,this.idArray,t.STATIC_DRAW),this.set_shader__(),this.set_transparent__()},set_shader__:function(){switch(this.geometryType){case g:this.shaderGeometryType=0,this.shaderNode=this.getBrowser().getPointShader();break;case A:this.shaderGeometryType=1,this.shaderNode=this.getBrowser().getLineShader();break;case x:case F:case R:this.shaderGeometryType=3,this.shaderNode=this.getBrowser().getDefaultShader();break;case w:this.shaderGeometryType=3,this.shaderNode=this.getBrowser().getDefaultShader()}},set_maxParticles__:function(){for(var t=this.particles,e=Math.max(0,this.maxParticles_.getValue()),i=this.numParticles,s=Math.min(t.length,e);i<s;++i)t[i].life=1,t[i].lifetime=-1;for(var i=t.length,s=e;i<s;++i)t[i]={life:1,lifetime:-1,elapsedTime:0,position:new l(0,0,0),velocity:new l(0,0,0),color:new h(1,1,1,1),distance:0};this.maxParticles=e,this.numParticles=Math.min(this.numParticles,e),this.emitterNode.isExplosive()||(this.creationTime=performance.now()/1e3),this.set_geometryType__()},set_particleLifetime__:function(){this.particleLifetime=this.particleLifetime_.getValue()},set_lifetimeVariation__:function(){this.lifetimeVariation=this.lifetimeVariation_.getValue()},set_emitter__:function(){this.emitterNode=o(n.X3DParticleEmitterNode,this.emitter_),this.emitterNode||(this.emitterNode=this.getBrowser().getDefaultEmitter()),this.createParticles=this.createParticles_.getValue()},set_physics__:function(){for(var t=this.physics_.getValue(),e=this.forcePhysicsModelNodes,i=this.boundedPhysicsModelNodes,s=0,r=i.length;s<r;++s)i[s].removeInterest("set_boundedPhysics__",this);e.length=0,i.length=0;for(var s=0,r=t.length;s<r;++s)try{for(var o=t[s].getValue().getInnerNode(),a=o.getType(),l=a.length-1;l>=0;--l){switch(a[l]){case n.ForcePhysicsModel:case n.WindPhysicsModel:e.push(o);break;case n.BoundedPhysicsModel:o.addInterest("set_boundedPhysics__",this),i.push(o);break;default:continue}break}}catch(t){}this.set_boundedPhysics__()},set_boundedPhysics__:function(){var t=this.boundedPhysicsModelNodes,e=this.boundedNormals,i=this.boundedVertices;e.length=0,i.length=0;for(var s=0,r=t.length;s<r;++s)t[s].addGeometry(e,i);this.boundedVolume=new f(i,e)},set_colorRamp__:function(){this.colorRampNode&&this.colorRampNode.removeInterest("set_color__",this),this.colorRampNode=o(n.X3DColorNode,this.colorRamp_),this.colorRampNode&&this.colorRampNode.addInterest("set_color__",this),this.set_color__(),this.set_transparent__()},set_color__:function(){for(var t=this.colorKey_,e=this.colorKeys,i=this.colorRamp,s=0,r=t.length;s<r;++s)e[s]=t[s];e.length=r,this.colorRampNode&&this.colorRampNode.getVectors(this.colorRamp);for(var s=i.length,r=t.length;s<r;++s)i[s]=new h(1,1,1,1);i.length=r,this.colorMaterial=!(!e.length||!this.colorRampNode)},set_texCoordRamp__:function(){this.texCoordRampNode&&this.texCoordRampNode.removeInterest("set_texCoord__",this),this.texCoordRampNode=o(n.X3DTextureCoordinateNode,this.texCoordRamp_),this.texCoordRampNode&&this.texCoordRampNode.addInterest("set_texCoord__",this),this.set_texCoord__()},set_texCoord__:function(){for(var t=this.texCoordKey_,e=this.texCoordKeys,i=this.texCoordRamp,s=0,r=t.length;s<r;++s)e[s]=t[s];e.length=r,this.texCoordRampNode&&this.texCoordRampNode.getTexCoord(i);for(var s=i.length,r=t.length*this.texCoordCount;s<r;++s)i[s]=new h(0,0,0,0);i.length=r,this.texCoordAnim=!(!e.length||!this.texCoordRampNode)},intersectsBox:function(t,e){},animateParticles:function(){var t=this.emitterNode,e=1/Math.max(10,this.getBrowser().getCurrentFrameRate()),i=this.deltaTime=(14*this.deltaTime+e)/15;if(t.isExplosive()){var s=performance.now()/1e3,r=this.particleLifetime+this.particleLifetime*this.lifetimeVariation;0===this.numParticles||s-this.creationTime>r?(this.creationTime=s,this.numParticles=this.maxParticles,this.createParticles=this.createParticles_.getValue(),i=Number.POSITIVE_INFINITY):this.createParticles=!1}else if(this.numParticles<this.maxParticles){var s=performance.now()/1e3,n=Math.max(0,Math.floor((s-this.creationTime)*this.maxParticles/this.particleLifetime));n&&(this.creationTime=s),this.numParticles=Math.floor(Math.min(this.maxParticles,this.numParticles+n))}if(t.getMass()){for(var o=this.forcePhysicsModelNodes,a=this.velocities,h=this.speeds,c=this.turbulences,d=this.deltaTime/t.getMass(),u=a.length,m=o.length;u<m;++u)a[u]=new l(0,0,0);for(var u=0,m=o.length;u<m;++u)o[u].addForce(u,t,a,c);for(var u=0,m=a.length;u<m;++u)a[u].multiply(d),h[u]=a[u].abs();this.numForces=m}else this.numForces=0;t.animate(this,i),this.updateGeometry(null),this.getBrowser().addBrowserEvent()},updateGeometry:function(t){switch(this.geometryType){case g:t||this.updatePoint();break;case A:t||this.updateLine();break;case x:case F:case R:this.updateQuad(t);break;case w:}},updatePoint:function(){var t=this.getBrowser().getContext(),e=this.particles,i=this.numParticles,s=this.positionArray,r=this.elapsedTimeArray,n=this.lifeArray,o=this.colorArray,a=this.vertexArray;if(this.colorMaterial){for(var l=0;l<i;++l){var h=e[l].color,c=4*l;o[c]=h.x,o[c+1]=h.y,o[c+2]=h.z,o[c+3]=h.w}t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,this.colorArray,t.STATIC_DRAW)}for(var l=0;l<i;++l){var d=e[l].position,u=e[l].elapsedTime/e[l].lifetime,m=3*l,c=4*l;s[m]=d.x,s[m+1]=d.y,s[m+2]=d.z,r[l]=u,n[l]=e[l].life,a[c]=d.x,a[c+1]=d.y,a[c+2]=d.z}t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,this.positionArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.elapsedTimeBuffer),t.bufferData(t.ARRAY_BUFFER,this.elapsedTimeArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.lifeBuffer),t.bufferData(t.ARRAY_BUFFER,this.lifeArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,this.vertexArray,t.STATIC_DRAW)},updateLine:function(){var t=this.getBrowser().getContext(),e=this.particles,i=this.numParticles,s=this.positionArray,r=this.elapsedTimeArray,n=this.lifeArray,o=this.colorArray,a=this.vertexArray,l=this.particleSize_.y/2;if(this.colorMaterial){for(var h=0;h<i;++h){var c=e[h].color,d=8*h;o[d]=c.x,o[d+1]=c.y,o[d+2]=c.z,o[d+3]=c.w,o[d+4]=c.x,o[d+5]=c.y,o[d+6]=c.z,o[d+7]=c.w}t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,this.colorArray,t.STATIC_DRAW)}for(var h=0;h<i;++h){var u=e[h],m=u.position,f=e[h].elapsedTime/e[h].lifetime,p=e[h].life,_=m.x,y=m.y,g=m.z,A=2*h,x=6*h,d=8*h;s[x]=_,s[x+1]=y,s[x+2]=g,s[x+3]=_,s[x+4]=y,s[x+5]=g,r[A]=f,r[A+1]=f,n[A]=p,n[A+1]=p,N.assign(u.velocity).normalize().multiply(l),a[d]=_-N.x,a[d+1]=y-N.y,a[d+2]=g-N.z,a[d+4]=_+N.x,a[d+5]=y+N.y,a[d+6]=g+N.z}t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,this.positionArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.elapsedTimeBuffer),t.bufferData(t.ARRAY_BUFFER,this.elapsedTimeArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.lifeBuffer),t.bufferData(t.ARRAY_BUFFER,this.lifeArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,this.vertexArray,t.STATIC_DRAW)},updateQuad:function(t){try{var e=this.getBrowser().getContext(),i=this.particles,s=this.maxParticles,r=this.numParticles,n=this.positionArray,o=this.elapsedTimeArray,a=this.lifeArray,l=this.colorArray,h=this.texCoordArray,c=this.normalArray,d=this.vertexArray,u=this.particleSize_.x/2,f=this.particleSize_.y/2;if(!t){if(this.colorMaterial){for(var p=0;p<s;++p){var _=i[p].color,y=24*p;l[y]=l[y+4]=l[y+8]=l[y+12]=l[y+16]=l[y+20]=_.x,l[y+1]=l[y+5]=l[y+9]=l[y+13]=l[y+17]=l[y+21]=_.y,l[y+2]=l[y+6]=l[y+10]=l[y+14]=l[y+18]=l[y+22]=_.z,l[y+3]=l[y+7]=l[y+11]=l[y+15]=l[y+19]=l[y+23]=_.w}e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,this.colorArray,e.STATIC_DRAW)}if(this.texCoordAnim&&this.texCoordArray.length){for(var g=this.texCoordKeys,A=this.texCoordRamp,x=g.length,F=0,p=0;p<s;++p){var w=i[p],v=w.elapsedTime/w.lifetime;if(1==x||v<=g[0])F=0;else if(v>=g[x-1])F=x-2;else{var P=m.upperBound(g,0,x,v,m.less);F=P<x?P-1:0}F*=this.texCoordCount;var b=A[F],S=A[F+1],M=A[F+2],I=A[F+3],y=24*p;h[y]=h[y+12]=b.x,h[y+1]=h[y+13]=b.y,h[y+2]=h[y+14]=b.z,h[y+3]=h[y+15]=b.w,h[y+4]=S.x,h[y+5]=S.y,h[y+6]=S.z,h[y+7]=S.w,h[y+8]=h[y+16]=M.x,h[y+9]=h[y+17]=M.y,h[y+10]=h[y+18]=M.z,h[y+11]=h[y+19]=M.w,h[y+20]=I.x,h[y+21]=I.y,h[y+22]=I.z,h[y+23]=I.w}
e.bindBuffer(e.ARRAY_BUFFER,this.texCoordBuffers[0]),e.bufferData(e.ARRAY_BUFFER,this.texCoordArray,e.STATIC_DRAW)}}if(this.geometryType===R){if(t){var z=this.getScreenAlignedRotation(t);N.set(z[0],z[1],z[2]).cross(B.set(z[3],z[4],z[5])).normalize();for(var E=N.x,O=N.y,U=N.z,p=0,x=18*s;p<x;p+=3)c[p]=E,c[p+1]=O,c[p+2]=U;e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer),e.bufferData(e.ARRAY_BUFFER,this.normalArray,e.STATIC_DRAW),C.set(-u,-f,0),T.set(u,-f,0),V.set(u,f,0),D.set(-u,f,0),z.multVecMatrix(C),z.multVecMatrix(T),z.multVecMatrix(V),z.multVecMatrix(D);for(var p=0;p<r;++p){var Y=i[p].position,L=i[p].elapsedTime/i[p].lifetime,X=Y.x,W=Y.y,G=Y.z,k=6*p,j=18*p,y=24*p;n[j]=n[j+3]=n[j+6]=n[j+9]=n[j+12]=n[j+15]=X,n[j+1]=n[j+4]=n[j+7]=n[j+10]=n[j+13]=n[j+16]=W,n[j+2]=n[j+5]=n[j+8]=n[j+11]=n[j+14]=n[j+17]=G,o[k]=o[k+1]=o[k+2]=o[k+3]=o[k+4]=o[k+5]=L,a[k]=a[k+1]=a[k+2]=a[k+3]=a[k+4]=a[k+5]=i[p].life,d[y]=d[y+12]=X+C.x,d[y+1]=d[y+13]=W+C.y,d[y+2]=d[y+14]=G+C.z,d[y+4]=X+T.x,d[y+5]=W+T.y,d[y+6]=G+T.z,d[y+8]=d[y+16]=X+V.x,d[y+9]=d[y+17]=W+V.y,d[y+10]=d[y+18]=G+V.z,d[y+20]=X+D.x,d[y+21]=W+D.y,d[y+22]=G+D.z}e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,this.positionArray,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.elapsedTimeBuffer),e.bufferData(e.ARRAY_BUFFER,this.elapsedTimeArray,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.lifeBuffer),e.bufferData(e.ARRAY_BUFFER,this.lifeArray,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.STATIC_DRAW)}}else if(!t){for(var p=0;p<r;++p){var Y=i[p].position,L=i[p].elapsedTime/i[p].lifetime,X=Y.x,W=Y.y,G=Y.z,k=6*p,j=18*p,y=24*p;n[j]=n[j+3]=n[j+6]=n[j+9]=n[j+12]=n[j+15]=X,n[j+1]=n[j+4]=n[j+7]=n[j+10]=n[j+13]=n[j+16]=W,n[j+2]=n[j+5]=n[j+8]=n[j+11]=n[j+14]=n[j+17]=G,o[k]=o[k+1]=o[k+2]=o[k+3]=o[k+4]=o[k+5]=L,a[k]=a[k+1]=a[k+2]=a[k+3]=a[k+4]=a[k+5]=i[p].life,d[y]=d[y+12]=X-u,d[y+1]=d[y+13]=W-f,d[y+2]=d[y+14]=G,d[y+4]=X+u,d[y+5]=W-f,d[y+6]=G,d[y+8]=d[y+16]=X+u,d[y+9]=d[y+17]=W+f,d[y+10]=d[y+18]=G,d[y+20]=X-u,d[y+21]=W+f,d[y+22]=G}e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,this.positionArray,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.elapsedTimeBuffer),e.bufferData(e.ARRAY_BUFFER,this.elapsedTimeArray,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.lifeBuffer),e.bufferData(e.ARRAY_BUFFER,this.lifeArray,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.STATIC_DRAW)}}catch(t){console.log(t)}},traverse:function(t,e){if(this.isActive_.getValue()){switch(t){case r.POINTER:break;case r.PICKING:break;case r.COLLISION:break;case r.DEPTH:e.addDepthShape(this);break;case r.DISPLAY:e.addDisplayShape(this)&&this.getAppearance().traverse(t,e)}this.geometryType===w&&this.getGeometry()&&this.getGeometry().traverse(t,e)}},depth:function(t,e,i){if(this.updateGeometry(e.modelViewMatrix),this.geometryType===w){var s=this.getGeometry();s&&s.displayParticlesDepth(t,e,i,this.particles,this.numParticles)}else{if(this.numParticles<=0)return;i.getValid()&&(i.enableFloatAttrib(t,"x3d_ParticleId",this.idBuffer,1),i.enableFloatAttrib(t,"x3d_ParticlePosition",this.positionBuffer,3),i.enableFloatAttrib(t,"x3d_ParticleElapsedTime",this.elapsedTimeBuffer,1),i.enableFloatAttrib(t,"x3d_ParticleLife",this.lifeBuffer,1),i.enableVertexAttribute(t,this.vertexBuffer),t.drawArrays(this.primitiveMode,0,this.numParticles*this.vertexCount),i.disableFloatAttrib(t,"x3d_ParticleId"),i.disableFloatAttrib(t,"x3d_ParticlePosition"),i.disableFloatAttrib(t,"x3d_ParticleElapsedTime"),i.disableFloatAttrib(t,"x3d_ParticleLife"))}},display:function(t,e){try{if(this.numParticles<=0)return;if(this.getAppearance().enable(t,e,this.shaderGeometryType),this.updateGeometry(e.modelViewMatrix),this.geometryType===w){var i=this.getGeometry();i&&i.displayParticles(t,e,this.particles,this.numParticles)}else{var s=e.browser,r=e.shaderNode;if(r.getCustom()||(r=this.shaderNode),r.getValid()){e.geometryType=this.shaderGeometryType,e.colorMaterial=this.colorMaterial,e.textureCoordinateNode=s.getDefaultTextureCoordinate(),r.enable(t),r.setLocalUniforms(t,e),r.enableFloatAttrib(t,"x3d_ParticleId",this.idBuffer,1),r.enableFloatAttrib(t,"x3d_ParticlePosition",this.positionBuffer,3),r.enableFloatAttrib(t,"x3d_ParticleElapsedTime",this.elapsedTimeBuffer,1),r.enableFloatAttrib(t,"x3d_ParticleLife",this.lifeBuffer,1),this.colorMaterial&&r.enableColorAttribute(t,this.colorBuffer),this.texCoordArray.length&&r.enableTexCoordAttribute(t,this.texCoordBuffers),this.normalArray.length&&r.enableNormalAttribute(t,this.normalBuffer),r.enableVertexAttribute(t,this.vertexBuffer);var n=!1;switch(this.geometryType){case g:case A:break;case x:case F:case R:n=!0;break;case w:}if(r.wireframe&&n)for(var o=0,a=this.numParticles*this.vertexCount;o<a;o+=3)t.drawArrays(r.primitiveMode,o,3);else{var l=c.prototype.determinant3.call(e.modelViewMatrix)>0;t.frontFace(l?t.CCW:t.CW),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.drawArrays(this.primitiveMode,0,this.numParticles*this.vertexCount)}r.disableFloatAttrib(t,"x3d_ParticleId"),r.disableFloatAttrib(t,"x3d_ParticlePosition"),r.disableFloatAttrib(t,"x3d_ParticleElapsedTime"),r.disableFloatAttrib(t,"x3d_ParticleLife"),r.disableColorAttribute(t),r.disableTexCoordAttribute(t),r.disableNormalAttribute(t),r.disable(t)}}this.getAppearance().disable(t,e)}catch(t){console.log(t)}},getScreenAlignedRotation:function(t){P.assign(t).inverse(),P.multDirMatrix(b.assign(l.zAxis)),P.multDirMatrix(S.assign(l.yAxis)),M.assign(S).cross(b),I.assign(b).cross(M);var e=b;return M.normalize(),I.normalize(),e.normalize(),this.rotation.set(M.x,M.y,M.z,I.x,I.y,I.z,e.x,e.y,e.z)}}),_}),t("x_ite/Components/ParticleSystems/PolylineEmitter",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Components/Rendering/IndexedLineSet","x_ite/Bits/X3DConstants","standard/Math/Numbers/Vector3","standard/Math/Algorithm"],function(t,e,i,s,r,n,o,a){"use strict";function l(t){s.call(this,t),this.addType(n.PolylineEmitter),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.direction=new o(0,0,0),this.polylineNode=new r(t),this.polylines=[],this.lengthSoFarArray=[0]}function h(t){return t.set(0,0,0)}return l.prototype=Object.assign(Object.create(s.prototype),{constructor:l,fieldDefinitions:new i([new e(n.inputOutput,"metadata",new t.SFNode),new e(n.inputOutput,"direction",new t.SFVec3f(0,1,0)),new e(n.inputOutput,"speed",new t.SFFloat),new e(n.inputOutput,"variation",new t.SFFloat(.25)),new e(n.initializeOnly,"mass",new t.SFFloat),new e(n.initializeOnly,"surfaceArea",new t.SFFloat),new e(n.inputOutput,"coordIndex",new t.MFInt32(-1)),new e(n.inputOutput,"coord",new t.SFNode)]),getTypeName:function(){return"PolylineEmitter"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"emitter"},initialize:function(){s.prototype.initialize.call(this),this.direction_.addInterest("set_direction__",this),this.coordIndex_.addFieldInterest(this.polylineNode.coordIndex_),this.coord_.addFieldInterest(this.polylineNode.coord_),this.polylineNode.coordIndex_=this.coordIndex_,this.polylineNode.coord_=this.coord_,this.polylineNode.rebuild_.addInterest("set_polyline",this),this.polylineNode.setPrivate(!0),this.polylineNode.setup(),this.set_direction__(),this.set_polyline()},set_direction__:function(){this.direction.assign(this.direction_.getValue()).normalize(),this.direction.equals(o.Zero)?this.getRandomVelocity=this.getSphericalRandomVelocity:delete this.getRandomVelocity},set_polyline:function(){var t=new o(0,0,0),e=new o(0,0,0);return function(){var i=this.vertices=this.polylineNode.getVertices().getValue();if(i.length){delete this.getRandomPosition;var s=0,r=this.lengthSoFarArray;r.length=1;for(var n=0,o=i.length;n<o;n+=8)t.set(i[n],i[n+1],i[n+2]),e.set(i[n+4],i[n+5],i[n+6]),s+=e.subtract(t).abs(),r.push(s)}else this.getRandomPosition=h}}(),getRandomPosition:function(t){var e=this.lengthSoFarArray,i=e.length,s=Math.random()*e[i-1],r=0,n=0,o=0;if(1==i||s<=e[0])r=0,o=0;else if(s>=e[i-1])r=i-2,o=1;else{var l=a.upperBound(e,0,i,s,a.less);if(l<i){n=l,r=l-1;var h=e[r],c=e[n];o=a.clamp((s-h)/(c-h),0,1)}else r=0,o=0}r*=8,n=r+4;var d=this.vertices,u=d[r],m=d[r+1],f=d[r+2],p=d[n],_=d[n+1],y=d[n+2];return t.x=u+o*(p-u),t.y=m+o*(_-m),t.z=f+o*(y-f),t},getRandomVelocity:function(t){var e=this.direction,i=this.getRandomSpeed();return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}}),l}),t("x_ite/Components/ParticleSystems/SurfaceEmitter",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Bits/X3DConstants","x_ite/Bits/X3DCast","standard/Math/Geometry/Triangle3","standard/Math/Numbers/Vector3","standard/Math/Algorithm"],function(t,e,i,s,r,n,o,a,l){"use strict";function h(t){s.call(this,t),this.addType(r.SurfaceEmitter),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.surfaceNode=null,this.areaSoFarArray=[0],this.direction=new a(0,0,0)}function c(t){return t.set(0,0,0)}return h.prototype=Object.assign(Object.create(s.prototype),{constructor:h,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"speed",new t.SFFloat),new e(r.inputOutput,"variation",new t.SFFloat(.25)),new e(r.initializeOnly,"mass",new t.SFFloat),new e(r.initializeOnly,"surfaceArea",new t.SFFloat),new e(r.initializeOnly,"surface",new t.SFNode)]),getTypeName:function(){return"SurfaceEmitter"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"emitter"},initialize:function(){s.prototype.initialize.call(this),this.surface_.addInterest("set_surface__",this),this.set_surface__()},set_surface__:function(){this.surfaceNode&&this.surfaceNode.rebuild_.removeInterest("set_geometry__",this),this.surfaceNode=n(r.X3DGeometryNode,this.surface_),this.surfaceNode&&this.surfaceNode.rebuild_.addInterest("set_geometry__",this),this.set_geometry__()},set_geometry__:function(){var t=new a(0,0,0),e=new a(0,0,0),i=new a(0,0,0);return function(){if(this.surfaceNode){delete this.getRandomPosition,delete this.getRandomVelocity;var s=0,r=this.areaSoFarArray,n=this.surfaceNode.getVertices().getValue();this.normals=this.surfaceNode.getNormals().getValue(),this.vertices=n,r.length=1;for(var a=0,l=n.length;a<l;a+=12)t.set(n[a],n[a+1],n[a+2]),e.set(n[a+4],n[a+5],n[a+6]),i.set(n[a+8],n[a+9],n[a+10]),s+=o.area(t,e,i),r.push(s)}else this.getRandomPosition=c,this.getRandomVelocity=this.getSphericalRandomVelocity}}(),getRandomPosition:function(t){var e=this.areaSoFarArray,i=e.length,s=Math.random()*e[i-1],r=0;if(1==i||s<=e[0])r=0;else if(s>=e[i-1])r=i-2;else{var n=l.upperBound(e,0,i,s,l.less);r=n<i?n-1:0}var o=Math.random(),a=Math.random();o+a>1&&(o=1-o,a=1-a);var h=1-o-a,c=12*r,d=this.vertices;t.x=o*d[c]+a*d[c+4]+h*d[c+8],t.y=o*d[c+1]+a*d[c+5]+h*d[c+9],t.z=o*d[c+2]+a*d[c+6]+h*d[c+10];var c=9*r,u=this.normals,m=this.direction;return m.x=o*u[c]+a*u[c+3]+h*u[c+6],m.y=o*u[c+1]+a*u[c+4]+h*u[c+7],m.z=o*u[c+2]+a*u[c+5]+h*u[c+8],t},getRandomVelocity:function(t){var e=this.getRandomSpeed(),i=this.direction;return t.x=i.x*e,t.y=i.y*e,t.z=i.z*e,t}}),h}),t("x_ite/Components/ParticleSystems/VolumeEmitter",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Components/Geometry3D/IndexedFaceSet","x_ite/Bits/X3DConstants","standard/Math/Numbers/Vector3","standard/Math/Numbers/Rotation4","standard/Math/Geometry/Line3","standard/Math/Geometry/Plane3","standard/Math/Geometry/Triangle3","standard/Math/Algorithm","standard/Math/Utility/BVH","standard/Math/Algorithms/QuickSort"],function(t,e,i,s,r,n,o,a,l,h,c,d,u,m){"use strict";function f(t){s.call(this,t),this.addType(n.VolumeEmitter),this.speed_.setUnit("speed"),this.mass_.setUnit("mass"),this.surfaceArea_.setUnit("area"),this.direction=new o(0,0,0),this.volumeNode=new r(t),this.areaSoFarArray=[0]}return f.prototype=Object.assign(Object.create(s.prototype),{constructor:f,fieldDefinitions:new i([new e(n.inputOutput,"metadata",new t.SFNode),new e(n.initializeOnly,"internal",new t.SFBool(!0)),new e(n.inputOutput,"direction",new t.SFVec3f(0,1,0)),new e(n.inputOutput,"speed",new t.SFFloat),new e(n.inputOutput,"variation",new t.SFFloat(.25)),new e(n.initializeOnly,"mass",new t.SFFloat),new e(n.initializeOnly,"surfaceArea",new t.SFFloat),new e(n.inputOutput,"coordIndex",new t.MFInt32(-1)),new e(n.inputOutput,"coord",new t.SFNode)]),getTypeName:function(){return"VolumeEmitter"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"emitter"},initialize:function(){s.prototype.initialize.call(this),this.direction_.addInterest("set_direction__",this),this.coordIndex_.addFieldInterest(this.volumeNode.coordIndex_),this.coord_.addFieldInterest(this.volumeNode.coord_),this.volumeNode.creaseAngle_=Math.PI,this.volumeNode.convex_=!1,this.volumeNode.coordIndex_=this.coordIndex_,this.volumeNode.coord_=this.coord_,this.volumeNode.rebuild_.addInterest("set_geometry__",this),this.volumeNode.setPrivate(!0),this.volumeNode.setup(),this.set_direction__(),this.set_geometry__()},set_direction__:function(){this.direction.assign(this.direction_.getValue()).normalize(),this.direction.equals(o.Zero)?this.getRandomVelocity=this.getSphericalRandomVelocity:delete this.getRandomVelocity},set_geometry__:function(){var t=new o(0,0,0),e=new o(0,0,0),i=new o(0,0,0);return function(){var s=0,r=this.areaSoFarArray,n=this.volumeNode.getNormals().getValue(),o=this.volumeNode.getVertices().getValue();this.normals=n,this.vertices=o,r.length=1;for(var a=0,l=o.length;a<l;a+=12)t.set(o[a],o[a+1],o[a+2]),e.set(o[a+4],o[a+5],o[a+6]),i.set(o[a+8],o[a+9],o[a+10]),s+=c.area(t,e,i),r.push(s);this.bvh=new u(o,n)}}(),getRandomPosition:function(){function t(t,e){return n.getDistanceToPoint(t)<n.getDistanceToPoint(e)}var e=new o(0,0,0),i=new o(0,0,0),s=new a(0,0,1,0),r=new l(o.Zero,o.zAxis),n=new h(o.Zero,o.zAxis),c=[],u=new m(c,t);return function(t){var a=this.areaSoFarArray,l=a.length,h=Math.random()*a[l-1],m=0;if(1==l||h<=a[0])m=0;else if(h>=a[l-1])m=l-2;else{var f=d.upperBound(a,0,l,h,d.less);m=f<l?f-1:0}var p=Math.random(),_=Math.random();p+_>1&&(p=1-p,_=1-_);var y=1-p-_,g=12*m,A=this.vertices;e.x=p*A[g]+_*A[g+4]+y*A[g+8],e.y=p*A[g+1]+_*A[g+5]+y*A[g+9],e.z=p*A[g+2]+_*A[g+6]+y*A[g+10];var g=9*m,x=this.normals;i.x=p*x[g]+_*x[g+3]+y*x[g+6],i.y=p*x[g+1]+_*x[g+4]+y*x[g+7],i.z=p*x[g+2]+_*x[g+5]+y*x[g+8],s.setFromToVec(o.zAxis,i),s.multVecRot(this.getRandomSurfaceNormal(i)),r.set(e,i),n.set(e,i);var F=this.bvh.intersectsLine(r,c);if(F-=F%2){u.sort(0,F);var f=2*Math.round(this.getRandomValue(0,F/2-1)),w=c[f],R=c[f+1],y=Math.random();return t.x=w.x+(R.x-w.x)*y,t.y=w.y+(R.y-w.y)*y,t.z=w.z+(R.z-w.z)*y,t}return t.set(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)}}(),getRandomVelocity:function(t){var e=this.direction,i=this.getRandomSpeed();return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}}),f}),t("x_ite/Components/ParticleSystems/WindPhysicsModel",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/ParticleSystems/X3DParticlePhysicsModelNode","x_ite/Bits/X3DConstants","standard/Math/Numbers/Vector3","standard/Math/Algorithm"],function(t,e,i,s,r,n,o){"use strict";function a(t){s.call(this,t),this.addType(r.WindPhysicsModel),this.speed_.setUnit("speed")}return a.prototype=Object.assign(Object.create(s.prototype),{constructor:a,fieldDefinitions:new i([new e(r.inputOutput,"metadata",new t.SFNode),new e(r.inputOutput,"enabled",new t.SFBool(!0)),new e(r.inputOutput,"direction",new t.SFVec3f),new e(r.inputOutput,"speed",new t.SFFloat(.1)),new e(r.inputOutput,"gustiness",new t.SFFloat(.1)),new e(r.inputOutput,"turbulence",new t.SFFloat)]),getTypeName:function(){return"WindPhysicsModel"},getComponentName:function(){return"ParticleSystems"},getContainerField:function(){return"physics"},getRandomSpeed:function(t){var e=Math.max(0,this.speed_.getValue()),i=e*Math.max(0,this.gustiness_.getValue());return t.getRandomValue(Math.max(0,e-i),e+i)},addForce:function(){var t=new n(0,0,0);return function(e,i,s,r){var a=i.surfaceArea_.getValue();if(this.enabled_.getValue()){var l=this.getRandomSpeed(i),h=.64615*Math.pow(10,2*Math.log(l));this.direction_.getValue().equals(n.Zero)?i.getRandomNormal(t):t.assign(this.direction_.getValue()).normalize(),s[e].assign(t.multiply(a*h)),r[e]=Math.PI*o.clamp(this.turbulence_.getValue(),0,1)}}}()}),a}),t(["x_ite/Components","x_ite/Browser/ParticleSystems/X3DParticleSystemsContext","x_ite/Components/ParticleSystems/BoundedPhysicsModel","x_ite/Components/ParticleSystems/ConeEmitter","x_ite/Components/ParticleSystems/ExplosionEmitter","x_ite/Components/ParticleSystems/ForcePhysicsModel","x_ite/Components/ParticleSystems/ParticleSystem","x_ite/Components/ParticleSystems/PointEmitter","x_ite/Components/ParticleSystems/PolylineEmitter","x_ite/Components/ParticleSystems/SurfaceEmitter","x_ite/Components/ParticleSystems/VolumeEmitter","x_ite/Components/ParticleSystems/WindPhysicsModel","x_ite/Components/ParticleSystems/X3DParticleEmitterNode","x_ite/Components/ParticleSystems/X3DParticlePhysicsModelNode"],function(t,e,i,s,r,n,o,a,l,h,c,d,u,m){"use strict";t.addComponent({name:"ParticleSystems",types:{BoundedPhysicsModel:i,ConeEmitter:s,ExplosionEmitter:r,ForcePhysicsModel:n,ParticleSystem:o,PointEmitter:a,PolylineEmitter:l,SurfaceEmitter:h,VolumeEmitter:c,WindPhysicsModel:d},abstractTypes:{X3DParticleEmitterNode:u,X3DParticlePhysicsModelNode:m},browser:e})})}();
